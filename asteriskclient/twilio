# Setup for Twilio SIP registration endpoint, Programmable Voice, TwiML Bin

## asterisk server creds

have SIP extension 700
have SIP password PASSWORD

## twilio creds

have credential list username 700
have credential list password PASSWORD

## set up TwiML bin dial700atstage

body:
  <?xml version="1.0" encoding="UTF-8"?>
  <Response>
  <Dial>
      <Sip username="700" password="PASSWORD">sip:999@futel-stage.phu73l.net</Sip>
  </Dial>
  </Response>

## set up TwiML bin dial700atprod

body:
  <?xml version="1.0" encoding="UTF-8"?>
  <Response>
  <Dial>
      <Sip username="700" password="PASSWORD">sip:999@futel-prod.phu73l.net</Sip>
  </Dial>
  </Response>

## add TwiML bin dial700attwilio

body:
<?xml version="1.0" encoding="UTF-8"?>
    <Response>
        <Dial answerOnBridge="true">
            <Sip>700@700.stage.futel.sip.us1.twilio.com</Sip>
        </Dial>
</Response>

## set up SIP domain 700.stage.futel.sip.twilio.com

Friendly name: 700.stage
SIP URI: 700.stage.futel (.sip.twilio.com)
Call control configuration: TwiML Bin: dial700atstage
Voice authentication: credential lists: 700
SIP registration: enabled
SIP Registration Authentication: credential lists: 700

## set up SIP domain 700.prod.futel.sip.twilio.com:

Friendly name: 700.prod
SIP URI: 700.prod.futel (.sip.twilio.com)
Call control configuration: TwiML Bin: dial700atprod
Voice authentication: credential lists: 700
SIP registration: enabled
SIP Registration Authentication: credential lists: 700

## set up SIP domain termination.stage.futel.sip.twilio.com

Friendly name: termination.stage.futel
SIP URI: termination.stage.futel (.sip.twilio.com)
Call control configuration: TwiML Bin: dial700stageattwilio
Voice authentication: credential lists: 700
SIP registration: disabled

XXX same for prod

## set up client

XXX this should be 700.stage.futel.us1.sip.twilio.com?
register to 700@700.stage.futel.sip.us1.twilio.com
register to 700@700.prod.futel.sip.us1.twilio.com
password is for credential list for 700

## test

register 700@700.stage.futel.sip.us1.twilio.com
dial any number, get server context configured for incoming call from ext 700

# TODO

incoming?
XXX dial from linphone? no
dial SIP url 700@700.stage.futel.sip.us1.twilio.com, call client
dial SIP url 700@700.prod.futel.sip.us1.twilio.com, call client
dial from asterisk? 
same => n,Dial(SIP/700@700.stage.futel.sip.us1.twilio.com)
same => n,Dial(SIP/700:<pass>@700.stage.futel.sip.us1.twilio.com)
no,
[May 19 22:10:56] VERBOSE[30123][C-00000000] app_dial.c: Called SIP/700@700.stage.futel.sip.us1.twilio.com
[May 19 22:10:56] NOTICE[30062][C-00000000] chan_sip.c: Failed to authenticate on INVITE to '"700" <sip:+15034681337@198.199.98.162>;tag=as3cefb3c0'
[May 19 22:10:56] VERBOSE[30123][C-00000000] app_dial.c: SIP/700.stage.futel.sip.us1.twilio.com-00000001 is circuit-busy

just have one SIP domain per group, for example year of creation
use registered extension to send to analog of outgoing-by-calling-extension
or can we find the calling extension and send to context on server for 999?
try BYOC trunk


# Setup for Twilio BYOC

## create TwiML bin dial700atstage

as described in Setup for Twilio SIP registration endpoint, Programmable Voice, TwiML Bin

XXX in progress

## create credential list futelterminationcredential
- friendly name futelterminationcredential
- user name futelterminationcredentialauthentication

## create termination sip domain futelterminationdomain.sip.twilio.com
- friendly name futelterminationdomain
- authentication credential list futelterminationcredential

## create origination connection policy futelpolicy
- friendly name futelpolicyfoo
- origination target sip:futel-stage.phu73l.net

## create trunk futeltrunk
- termination sip domains futelterminationdomain
- origination connection policy futelpolicy
- application confguration: a call comes in: XXX was dial700atstage

## register asterisk for termination

sip_callcentric.conf
[twilio-byoc-termination](+)
defaultuser=futelterminationcredential
remotesecret=...

sip.conf
[twilio-byoc-termination](twilio-trunk)
host=futelterminationdomain.sip.us1.twilio.com
; to be populated in sip_callcentric.conf                                 
defaultuser=
remotesecret=

XXX dup for prod
XXX want one bin for all exts
XXX what next?



register client

receive call
set up origination, make call
