# Setup for Twilio SIP registration endpoint, Programmable Voice, TwiML Bin

## asterisk server creds

have SIP extension 700, 701
have SIP password PASSWORD (same for all extensions)

## twilio creds

have credential termination:PASSWORD
have extension credential list usernames 700:PASSWORD, 701:PASSWORD, ...

## configure twilio functions

enable ACCOUNT_SID and AUTH_TOKEN
environment variables:
stage_termination_uri sip:999@futel-stage.phu73l.net
stage_origination_host origination-stage.futel.sip.us1.twilio.com
prod_termination_uri sip:999@futel-prod.phu73l.net
password PASSWORD (asterisk sip extension common password)

## create twilio functions for origination

friendly name origination-stage
path origination-stage
body:

usernameFromSip = function(sipAddress) {
    // eg "sip:+15035551212@foobar.sip.us1.twilio.com";
    sipAddress = sipAddress.replace("sip:", "");
    sipAddress = sipAddress.replace(/@.*/, "");
    return sipAddress;
};

exports.handler = function(context, event, callback) {
    var sipUri = context.stage_termination_uri;
    var client = context.getTwilioClient();
    var username = event.From;
    username = usernameFromSip(username);
    let twiml = new Twilio.twiml.VoiceResponse();
    twiml.dial().sip(
        {username:username, password: context.password},
        sipUri);
    callback(null, twiml);
};

XXX same for prod

## create twilio functions for termination

friendly name termination-stage
path termination-stage
body:

usernameFromSip = function(sipAddress) {
    // eg "sip:+15035551212@foobar.sip.us1.twilio.com";
    sipAddress = sipAddress.replace("sip:", "");
    sipAddress = sipAddress.replace(/@.*/, "");
    return sipAddress;
};

exports.handler = function(context, event, callback) {
    var sipHost = context.stage_origination_host;
    var client = context.getTwilioClient();
    var username = event.To;
    username = usernameFromSip(username);
    let twiml = new Twilio.twiml.VoiceResponse();
    twiml.dial().sip(username + "@" + sipHost);
    callback(null, twiml);
};

XXX same for prod

## set up SIP domain for origination

Friendly name: origination-stage
SIP URI: origination-stage.futel (.sip.twilio.com)
Call control configuration: function: origination-stage
Voice authentication: credential lists: 700, 701
SIP registration: enabled        
SIP Registration Authentication: credential lists: 700, 701

XXX same for prod

## set up SIP domain for termination

Friendly name: termination-stage
SIP URI: termination-stage.futel (.sip.twilio.com)
Call control configuration: function: termination-stage
Voice authentication: credential lists: termination
SIP registration: disabled

XXX same for prod

## set up client

register to sip:700@origination-stage.futel.sip.us1.twilio.com)
register to sip:700@origination-prod.futel.sip.us1.twilio.com)
same for 701
password is as for credential list for 700, 701

## test

register
dial any number, get outgoing-by-calling-extension context for 700
have server Dial(SIP/700@twilio-pv-termination), registered client gets call

XXX todo
test having multiple termination clients same creds - stage and prod
