## Deploy a vpnbox to Digital Ocean

## Ongoing:

in conf, have:
(or create by following README.ssl)
ca.crt ca.key dh1024.pem
id_rsa
server.crt server.csr server.key
client.conf.[prod|stage] (not used by server)
client/client.crt client/client.csr client/client.key (not used by server)

give client.conf.[prod|stage] to client

## Deploy stage vpnbox to digital ocean manually

all droplets:
hostname vpnbox-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or check out release branch

create droplet from snapshot baseconfig_stage
create or replace A record for new vpnbox_stage
wait for DNS to propagate
src/vpnbox.sh vpnbox-stage.phu73l.net
save snapshot vpnbox_stage

test

connect client to vpnbox_stage as in asteriskbox README.client
or vpnclient README

## promote stage to prod
## we assume that we are creating foo or bar and retiring the existing
rename vpnbox-stage droplet to new vpnbox-prod-foo|bar
rename vpnbox-stage hostname to new vpnbox-prod-foo|bar
  "hostname vpnbox-prod-foo" and edit /etc/sysconfig/network
change A record for vpnbox-stage to point to new vpnbox-prod-foo|bar
remove A record for vpnbox-stage
wait for DNS to propagate
refresh iptables on futel-prod
XXX assumes iptables.sh is still in install dir /vagrant
  service iptables stop && /vagrant/src/iptables.sh && service iptables save && service iptables start
stop openvpn on old vpnbox-prod-foo|bar
  service openvpn stop
XXX sip peers may be unreachable until something happens?
test that new vpnbox-prod-foo|bar is being used
  sip show peers on futel-prod
  service openvpn status on new vpnbox-prod-foo|bar
halt old vpnbox-prod-foo|bar
make a snapshot of old vpnbox-prod-foo|bar
destroy droplet old vpnbox-prod-foo|bar
