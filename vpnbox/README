## Deploy a vpnbox to Digital Ocean

## Ongoing:

in conf, have:
(or create by following README.ssl)
ca.crt ca.key
client.conf.[prod|stage]
client.crt client.csr client.key dh1024.pem
id_rsa
server.crt server.csr server.key

give client.conf.[prod|stage] to client

## Deploy stage vpnbox to digital ocean manually

all droplets:
hostname vpnbox-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or check out release branch

create droplet from snapshot baseconfig_stage
src/vpnbox.sh <ip>
save snapshot vpnbox_stage

test

create or replace A record for new vpnbox_stage
wait for DNS to propagate

connect client to vpnbox_stage as in asteriskbox README.client

## promote stage to prod
rename vpnbox-prod droplet to vpnbox-prod-back
rename vpnbox-stage droplet to vpnbox-prod
rename vpnbox-stage hostname to vpnbox-prod
rename vpnbox-prod hostname to vpnbox-prod-back
  "hostname vpnbox-prod" and edit /etc/sysconfig/network
change A record for vpnbox-prod to point to new vpnbox-prod
change A record for futel-vpnbox to point to new vpnbox-prod (legacy)
change A record for vpnbox-stage to point to old vpnbox-prod
wait for DNS to propagate
stop openvpn on old vpnbox-prod
  "service openvpn stop"
refresh iptables on futel-prod
is there a way to make iptables keep the hostname so this isn't required?
  /etc/init.d/iptables stop
  /vagrant/src/iptables.sh
  service iptables save
  service iptables restart
XXX what needds to be restarted?
test vpnbox-prod
make a snapshot of vpnbox-prod-back
destroy droplet vpnbox-prod-back
