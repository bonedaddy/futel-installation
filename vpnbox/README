## Deploy a vpnbox to Digital Ocean

## Ongoing:

in conf, have:
(or create by following README.ssl)
ca.crt ca.key
client.conf.[prod|stage]
client.crt client.csr client.key dh1024.pem
id_rsa
server.crt server.csr server.key

give client.conf.[prod|stage] to client

## Deploy stage vpnbox to digital ocean manually

all droplets:
hostname vpnbox-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or check out release branch

create droplet from snapshot baseconfig_stage
src/vpnbox.sh <ip>
save snapshot vpnbox_stage

test

create or replace A record for new vpnbox_stage
wait for DNS to propagate

connect client to vpnbox_stage as in asteriskbox README.client

## promote stage to prod
if existing, rename vpnbox-prod-foo|bar droplet to vpnbox-prod-foo|bar-back
rename vpnbox-stage droplet to vpnbox-prod-foo|bar
rename vpnbox-stage hostname to vpnbox-prod-foo|bar
if existing, rename vpnbox-prod-foo|bar hostname to vpnbox-prod-foo|bar-back
  "hostname vpnbox-prod-foo" and edit /etc/sysconfig/network
change A record for vpnbox-prod-foo|bar
  to point to new vpnbox-prod-foo|bar
change A record for vpnbox-stage to point to old vpnbox-prod-foo|bar
wait for DNS to propagate
refresh iptables on futel-prod
XXX must recopy /vagrant/src/iptable.sh to futel-prod first
  /etc/init.d/iptables stop && /vagrant/src/iptables.sh && service iptables save && service iptables start
stop openvpn on old vpnbox-prod-foo|bar
  "service openvpn stop"
XXX sip peers are unreachable until they make outgoing connection?
test that new vpnbox-prod-foo|bar is being used
  sip show peers on futel-prod
  service openvpn status on new vpnbox-prod-foo|bar
make a snapshot of old vpnbox-prod-foo|bar
destroy droplet old vpnbox-prod-foo|bar
