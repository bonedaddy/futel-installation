## Deploy an asterisk server to Digital Ocean

## test

cd src/var/lib/asterisk/agi-bin
python -m unittest discover test

## Deploy stage asteriskbox to digital ocean manually

create droplet
image CentOS 7.x x64
hostname futel-stage.phu73l.net
size smallest
region San Francisco 1
ssh key (personal key)

create or replace A record for new futel-stage
wait for DNS to propagate

create or check out release branch

SSH into prod to find out what conf version is being used:

  ssh -F src/ssh_config futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

deploy stage:

  ansible-playbook -i hosts baseinstall_playbook.yml --vault-password-file=conf/vault_pass.txt --extra-vars conf_version=<conf version not used by prod>
  ansible-playbook -i hosts ssh_playbook.yml  
  ansible-playbook -i hosts secure_playbook.yml
  ansible-playbook -i hosts sync_playbook.yml

if testplan has changed since last release branch, update google sheet testplan,
keeping dates of nonupdated completed tests
test stage against google sheet testplan

## promote stage to prod

rename futel-prod.phu73l.net droplet to futel-prod-back
rename futel-stage.phu73l.net droplet to futel-prod.phu73l.net
rename futel-prod.phu73l.net hostname to futel-prod-back
rename futel-stage.phu73l.net hostname to futel-prod.phu73l.net
  ssh -t -F src/ssh_config futel-prod.phu73l.net 'sudo hostnamectl set-hostname futel-prod-back'
  ssh -t -F src/ssh_config futel-stage.phu73l.net 'sudo hostnamectl set-hostname futel-prod.phu73l.net'
ansible-playbook -i hosts sync_playbook.yml  
change A record for futel-prod.phu73l.net to point to new futel-prod.phu73l.net
remove A record for futel-stage.phu73l.net
point all callcentric DID forwarding rules to extensions corresponding to new conf_version on futel-prod.phu73l.net
  futel-r2d2 user to foo|bar
point all voip.ms DID forwarding rules to subaccounts corresponding to new conf_version on futel-prod.phu73l.net
  185060_prod-foo|bar subaccount
wait for DNS to propagate
stop asterisk on futel-prod-back
  XXX cp ssh_config and use for Host * if kicked out already
  sudo service asterisk stop
make a snapshot of futel-prod-back

  # XXX not working
  #ansible-playbook -i hosts post_promote_playbook.yml --vault-password-file=conf/vault_pass.txt
  instead, delete droplet futel-prod-back

test that prod outgoing calls work
test that prod incoming call to incoming line works
test that prod incoming calls to extensions work or get channel unavailable
remove snapshots of futel-prod-back except for most recent
test that prod incoming calls to extensions work (may take time)

## update iptables

This is done after a new vpnbox is deployed.

  ansible-playbook -i hosts secure_playbook.yml
