## Deploy an asterisk server to Digital Ocean

## Deploy stage asteriskbox to digital ocean manually

all droplets:
image CentOS 6.8 x32
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

create droplet

create or replace A record for new futel-stage
wait for DNS to propagate

create or check out release branch

SSH into prod to find out what conf version is being used:
ssh -F src/ssh_config futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

ansible-playbook -i hosts baseinstall_playbook.yml --extra-vars conf_version=<conf version not used by prod>
ansible-playbook -i hosts secure_playbook.yml
src/promote_stage.sh futel-stage.phu73l.net
ssh -F src/ssh_config futel-stage.phu73l.net 'sudo halt'
create snapshot
start droplet

if testplan has changed since last release branch, update google sheet testplan,
keeping dates of nonupdated completed tests
test stage against google sheet testplan

## promote stage to prod

rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
rename futel-prod hostname to futel-prod-back
rename futel-stage hostname to futel-prod
  ssh -t -F src/ssh_config futel-prod.phu73l.net
  sudo hostname futel-prod-back && sudo sed -i '$s/futel-prod/futel-prod-back/' /etc/sysconfig/network
  ssh -t -F src/ssh_config futel-stage.phu73l.net
  sudo hostname futel-prod && sudo sed -i '$s/futel-stage/futel-prod/' /etc/sysconfig/network
src/promote_stage.sh futel-stage.phu73l.net 
change A record for futel-prod to point to new futel-prod
remove A record for futel-stage
point all callcentric DID forwarding rules to extensions corresponding to new
futel-prod conf_version
  futel-r2d2 user to foo|bar
point all voip.ms DID forwarding rules to subaccounts corresponding to new
futel-prod conf_version
  185060_prod-foo|bar subaccount
wait for DNS to propagate
stop asterisk on futel-prod-back
  sudo service asterisk stop
halt futel-prod-back
make a snapshot of futel-prod-back
test that futel-prod outgoing calls work
test that futel-prod incoming call to incoming line works
test that futel-prod incoming calls to extensions work or get channel unavailable
remove snapshots of futel-prod-back except for most recent
test that futel-prod incoming calls to extensions work (may take time)
destroy droplet futel-prod-back
remove snapshots of futel-stage
