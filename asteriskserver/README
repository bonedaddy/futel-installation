## Deploy a futel asterisk server to Digital Ocean

## Ongoing:
have futel-vpnbox
copy src/backup.sh to /etc/cron.daily/backup-futel-prod on eurydice

for each installation, have a callcentric account with pay per call and two DID free phone numbers
for each account, have two extensions, one with caller ID of incoming number
for each account, have a DID forwarding rule pointing the incoming number to its prod extension
when we have a direct VM number, have a callcentric DID forwarding rule pointing it to a prod account

## Deploy stage to digital ocean manually

all droplets:
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

SSH into prod to find out what conf version is being used:
ssh -o StrictHostKeyChecking=no -t -i conf/id_rsa futel@futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

in conf, create or have:
sip_callcentric.conf.<conf_version> pointing to extension
sip_secret.conf extensions_secret.conf
id_rsa id_rsa.pub

create droplet from image CentOS 6.5 x32
src/make_baseinstall.sh <ip>
save snapshot baseinstall_stage

create droplet from snapshot baseinstall_stage
src/make_baseconfig.sh <ip>
save snapshot baseconfig_stage

create droplet from snapshot baseconfig_stage
src/make_asteriskbox.sh <ip> <conf_version>
save snapshot asteriskbox_stage, or don't

test

create or replace A record for new futel-stage
wait for DNS to propagate

## promote stage to prod

if there are any uncheckedin recordings, copy from /opt/asterisk/var/lib/asterisk/sounds/futel on prod, and check in
src/promote_stage.sh futel-stage.phu73l.net # or ip address if not propagated
rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
rename futel-stage hostname to futel-prod
change A record for futel-prod to point to new futel-prod
change A record for futel-stage to point to old futel-prod
point all callcentric DID forwarding rules to the extensions used by new futel-prod
wait for DNS to propagate
# XXX DNS takes time, incoming calls won't go to the right place, what about
#     SIP devices already connected to hosts?
update DID forwarding rule sending incoming prod numbers to new prod extensions
test futel-prod
make a snapshot of futel-prod-back
destroy droplet futel-prod-back
