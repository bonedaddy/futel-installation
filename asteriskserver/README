## Deploy an asterisk server to Digital Ocean

in conf, have:
logwatch.conf sasl_passwd
sip_callcentric.conf.<conf_version> pointing to extension
sip_secret.conf extensions_secret.conf
id_rsa id_rsa.pub

## Deploy stage asteriskbox to digital ocean manually

all droplets:
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or replace A record for new futel-stage
wait for DNS to propagate

create or check out release branch

SSH into prod to find out what conf version is being used:
ssh -F src/ssh_config futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

create droplet from image CentOS 6.7 x32
src/baseinstall.sh futel-stage.phu73l.net
optionally save snapshot baseinstall_stage
src/baseconfig.sh futel-stage.phu73l.net
optionally save snapshot baseconfig_stage
src/asteriskbox.sh futel-stage.phu73l.net <conf version not used by prod>
save snapshot asteriskbox_stage
src/promote_stage.sh futel-stage.phu73l.net

test

## promote stage to prod

rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
rename futel-prod hostname to futel-prod-back
rename futel-stage hostname to futel-prod
  ssh -F src/ssh_config futel-prod.phu73l.net "hostname futel-prod-back && sed -i '$s/futel-prod/futel-prod-back/' /etc/sysconfig/network"
  ssh -F src/ssh_config futel-stage.phu73l.net "hostname futel-prod && sed -i '$s/futel-stage/futel-prod/' /etc/sysconfig/network"
src/promote_stage.sh futel-stage.phu73l.net 
change A record for futel-prod to point to new futel-prod
remove A record for futel-stage
point all callcentric DID forwarding rules to extensions corresponding to new
futel-prod conf_version
  kra user to oskar incoming
  futel-r2d2 user to r2d2 incoming
point all voip.ms DID forwarding rules to subaccounts corresponding to new
futel-prod conf_version
  oskar-in, 1337, xnor, tish-in, incoming, demo to prod-foo|bar subaccount
  ctrlh to ctrlh subaccount
  ctrlh-in to ctrlh-in subaccount
wait for DNS to propagate
test that futel-prod outgoing calls work
test that futel-prod incoming calls work or get channel unavailable
stop asterisk on futel-prod-back
halt futel-prod-back
test that futel-prod incoming calls work (may take time)
make a snapshot of futel-prod-back
destroy droplet futel-prod-back
