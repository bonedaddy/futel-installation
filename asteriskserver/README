## Deploy an asterisk server to Digital Ocean

## Ongoing:

have vpnbox-prod-foo or vpnbox-prod-bar
copy src/backup.sh to /etc/cron.daily/backup-futel-prod on eurydice

in conf, have:
logwatch.conf sasl_passwd
sip_callcentric.conf.<conf_version> pointing to extension
sip_secret.conf extensions_secret.conf
id_rsa id_rsa.pub

## Deploy stage asteriskbox to digital ocean manually

all droplets:
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or replace A record for new futel-stage
wait for DNS to propagate

create or check out release branch

SSH into prod to find out what conf version is being used:
ssh -p42422 -o StrictHostKeyChecking=no -t -i conf/id_rsa futel@futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

create droplet from image CentOS 6.5 x32
src/baseinstall.sh futel-stage.phu73l.net
save snapshot baseinstall_stage

create droplet from snapshot baseinstall_stage
src/baseconfig.sh futel-stage.phu73l.net
save snapshot baseconfig_stage

create droplet from snapshot baseconfig_stage
use the conf_version not being used by prod
src/asteriskbox.sh futel-stage.phu73l.net <conf_version>
save snapshot asteriskbox_stage
src/promote_stage.sh futel-stage.phu73l.net

test

## promote stage to prod

rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
rename futel-prod hostname to futel-prod-back
rename futel-stage hostname to futel-prod
  "hostname futel-prod" and edit /etc/sysconfig/network
src/promote_stage.sh futel-stage.phu73l.net 
change A record for futel-prod to point to new futel-prod
remove A record for futel-stage
point all callcentric DID forwarding rules to new futel-prod extensions:
  kra user to oskar incoming
  futel-r2d2 user to r2d2 incoming
point all voip.ms DID forwarding rules to new futel-prod subaccounts:
  oskar-in to oskar-in subaccount
wait for DNS to propagate
stop asterisk on futel-prod-back? restart asterisk on futel-prod? wait? nop?
test futel-prod
halt futel-prod-back
make a snapshot of futel-prod-back
destroy droplet futel-prod-back
