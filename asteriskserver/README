## Deploy a futel asterisk server to Digital Ocean

## Ongoing:
have futel-vpnbox
copy src/backup.sh to /etc/cron.daily/backup-futel-prod on eurydice

have a callcentric DID forwarding rule  pointing the incoming number to prod
have a callcentric DID forwarding rule pointing the VM number to prod

## Deploy stage to digital ocean manually
(or prod, but normally, deploy stage and promote to prod)

all droplets:
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

SSH into prod to find out what conf version is being used:
ssh -o StrictHostKeyChecking=no -t -i conf/id_rsa futel@futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_local.conf /opt/asterisk/etc/asterisk/sip_callcentric.conf'

in conf, create or have:
sip_callcentric.conf.<conf_version> sip_local.conf.<conf_version>
sip_secret.conf extensions_local.conf extensions_secret.conf
id_rsa id_rsa.pub

create droplet from image CentOS 6.5 x32
src/make_baseinstall.sh <ip>
save snapshot baseinstall_stage

create droplet from snapshot baseinstall_stage
src/make_baseconfig.sh <ip>
save snapshot baseconfig_stage

create droplet from snapshot baseconfig_stage
src/make_asteriskbox.sh <ip> <conf_version>
save snapshot asteriskbox_stage, or don't

create or replace A record for new futel-stage
wait for DNS to propagate

## promote stage to prod

make a snapshot of prod XXX short downtime
if there are any uncheckedin recordings, copy from /opt/asterisk/var/lib/asterisk/sounds/futel from prod to stage, and check in
src/promote_stage.sh futel-stage.phu73l.net # or ip address if not propagated
rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
change A record for futel-prod to point to new futel-prod
change A record for futel-stage to point to old futel-prod
wait for DNS to propagate
# XXX DNS takes hours, which is probably OK if SIP devices are talking to 
      hostnames, but incoming calls won't go to the right place
update DID forwarding rule sending incoming prod number to new prod's extension
test futel-prod
shut down, destroy droplet futel-prod-back




