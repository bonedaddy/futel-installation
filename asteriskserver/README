## Deploy an asterisk server to Digital Ocean

## Ongoing:

have vpnbox-prod-foo or vpnbox-prod-bar
copy src/backup.sh to /etc/cron.daily/backup-futel-prod on eurydice

for each installation, have a callcentric account with pay per call and two DID free phone numbers
for each account, have two extensions, one with caller ID of incoming number
for each account, have a DID forwarding rule pointing the incoming number to its prod extension
when we have a direct VM number, have a callcentric DID forwarding rule pointing it to a prod account

in conf, have:
logwatch.conf sasl_passwd
sip_callcentric.conf.<conf_version> pointing to extension
sip_secret.conf extensions_secret.conf
id_rsa id_rsa.pub

## Deploy stage asteriskbox to digital ocean manually

all droplets:
hostname futel-stage
size smallest
region San Francisco 1
ssh key (personal key)

create or check out release branch

SSH into prod to find out what conf version is being used:
ssh -p42422 -o StrictHostKeyChecking=no -t -i conf/id_rsa futel@futel-prod.phu73l.net 'grep "foo\|bar" /opt/asterisk/etc/asterisk/sip_callcentric.conf'

create droplet from image CentOS 6.5 x32
src/baseinstall.sh <ip>
save snapshot baseinstall_stage

create droplet from snapshot baseinstall_stage
src/baseconfig.sh <ip>
save snapshot baseconfig_stage

create droplet from snapshot baseconfig_stage
use the conf_version not being used by prod
src/asteriskbox.sh <ip> <conf_version>
save snapshot asteriskbox_stage

test

create or replace A record for new futel-stage
wait for DNS to propagate

## promote stage to prod

src/promote_stage.sh futel-stage.phu73l.net # or ip address if not propagated
rename futel-prod droplet to futel-prod-back
rename futel-stage droplet to futel-prod
rename futel-prod hostname to futel-prod-back
rename futel-stage hostname to futel-prod
  "hostname futel-prod" and edit /etc/sysconfig/network
change A record for futel-prod to point to new futel-prod
remove A record for futel-stage
point all callcentric DID forwarding rules to new futel-prod extensions:
  kra user to oskar incoming
  futel-r2d2 user to r2d2 incoming
point all voip.ms DID forwarding rules to new futel-prod subaccounts:
  oskar-in to oskar-in subaccount
wait for DNS to propagate
test futel-prod
make a snapshot of futel-prod-back
destroy droplet futel-prod-back
