[general]
clearglobalvars=no

[globals]
TRUNK=DAHDI/G2
;ypsibell_extension=630
;xhurch_extension=640
iprc_extension=650
garth_extension=655
oskar_extension=668
r2d2_extension=670
oskar_in_extension=667
xnor_extension=680
demo_extension=700
r2d2_incoming=19149775129
twilio_oskar_in_incoming=+15034448759
twilio_stage_oskar_in_incoming=+15036163619
twilio_oskar_incoming=+15039465227
twilio_garth_incoming=+15039266271
twilio_xnor_incoming=+15034449412 
voipms_oskar_incoming=5037644393
voipms_xnor_incoming=5032087258
voipms_garth_incoming=5032785986
voipms_leet_incoming=5034681337
voipms_demo_incoming=5418762084
max_iterations=10

[macro-say]
; first arg is name of statement file, rest are preferred subdirs,
; ignored if empty
exten => s,1,AGI(sound_path.agi,${ARG1},${MACRO_CONTEXT},${ARG2})
same => n,Background(${agi_out})

[macro-metric]
exten => s,1,AGI(metric.agi,${ARG1})

; dial number with timeout if it passes filter
[macro-filterdial]
exten => s,1,Macro(metric,macro-filterdial)
; filter or die
same => n,AGI(filter_outgoing.agi,${ARG1})
; friction, which may or may not die
same => n,AGI(friction.agi,filterdial)
; we passed, find timeout, if any, and dial
same => n,AGI(call_timeout.agi)
same => n,Macro(dial,${ARG1},${agi_out})

; dial number given by ARG1
; with timeout given by ARG2 in dial command syntax (which can be empty)
[macro-dial]
exten => s,1,Macro(metric,macro-dial)
same => n,Dial(SIP/${ARG1}@${outgoingchannel},,g${ARG2})
same => n,Goto(s,${DIALSTATUS})
; unsuccessful, try again
same => n(CHANUNAVAIL),Macro(dial-tryagain,${ARG1},${ARG2})
same => n(CONGESTION),Macro(dial-tryagain,${ARG1},${ARG2})
; successful, fall through
same => n(ANSWER),NoOp
same => n(NOANSWER),NoOp
same => n(BUSY),NoOp
same => n(CANCEL),NoOp
same => n,Macro(metric,outgoing-dialstatus-${DIALSTATUS})
same => n,Hangup

; dial number given by ARG1
; with timeout given by ARG2 in dial command syntax (which can be empty)
[macro-dial-tryagain]
exten => s,1,Macro(metric,macro-dial-tryagain)
same => n,Wait(1)
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,Dial(SIP/${ARG1}@${outgoingchannel},,g${ARG2})
same => n,Macro(metric,outgoing-dialstatus-${DIALSTATUS})
same => n,Goto(s,${DIALSTATUS})
; unsuccessful
same => n(CHANUNAVAIL),NoOp
same => n,Macro(outgoing-unavailable-message)
; unsuccessful
same => n(CONGESTION),NoOp
same => n,Macro(outgoing-unavailable-message)
; successful, fall through
same => n(ANSWER),NoOp
same => n(NOANSWER),NoOp
same => n(BUSY),NoOp
same => n(CANCEL),NoOp
same => n(done),NoOp
same => n,Hangup

[macro-outgoing-unavailable-message]
exten => s,1,Macro(metric,outgoing-unavailable-message)
same => n,Macro(say,outgoing-circuits)
same => n,Macro(say,are)
same => n,Macro(say,currently-unavailable)
same => n,Macro(say,please)
same => n,Macro(say,try-again-later)
same => n,Hangup

[macro-setup-iteration]
exten => s,1,Set(context_iterator=0)

; increment iterator, hangup if iterator is too large, otherwise return
[macro-iterate-guard]
exten => s,1,Set(context_iterator=$[ ${context_iterator} + 1 ])
same => n,GotoIf($[ ${context_iterator} > ${max_iterations} ]?hangup)
same => n,MacroExit
same => n(hangup),Macro(say,goodbye)
same => n,Hangup

; extension to start incoming call
[default-incoming]
exten => _!,1,Macro(metric,default-incoming)
; set variable to the number called, which is in SIP_HEADER(To)
same => n,Set(caller=${CUT(CUT(SIP_HEADER(To),@,1),:,2)})
same => n,Goto(incoming-route-by-caller,s,1)

[incoming-route-by-caller]
; route to appropriate context based on call origin
same => s,1,gotoIf($["${caller}" = "${twilio_oskar_incoming}"]?ring-oskar,s,1)
same => n,gotoIf($["${caller}" = "${r2d2_incoming}"]?ring-r2d2,s,1)
same => n,gotoIf($["${caller}" = "${twilio_oskar_in_incoming}"]?ring-oskar-in,s,1)
same => n,gotoIf($["${caller}" = "${twilio_stage_oskar_in_incoming}"]?ring-oskar-in,s,1)
same => n,gotoIf($["${caller}" = "${twilio_garth_incoming}"]?ring-garth,s,1)
same => n,gotoIf($["${caller}" = "${twilio_xnor_incoming}"]?ring-xnor,s,1)
; fallback, go to the incoming menu
same => n,Goto(incoming-ivr,s,1)

[ring-oskar]
exten => s,1,Macro(metric,ring-oskar)
same => n,Dial(SIP/${oskar_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[ring-r2d2]
exten => s,1,Macro(metric,ring-r2d2)
same => n,Dial(SIP/${r2d2_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[ring-oskar-in]
exten => s,1,Macro(metric,ring-oskar-in)
same => n,Dial(SIP/${oskar_in_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[ring-xnor]
exten => s,1,Macro(metric,ring-xnor)
same => n,Dial(SIP/${xnor_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[ring-garth]
exten => s,1,Macro(metric,ring-garth)
same => n,Dial(SIP/${garth_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[ring-demo]
exten => s,1,Macro(metric,ring-demo)
same => n,Dial(SIP/${demo_extension})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[incoming-ivr]
exten => s,1,Macro(metric,incoming-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,Answer(500)       ; is this necessary?
same => n,WaitExten(0.1)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-fewtel-voice-conference)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-three)
same => n,Macro(say,to-ring-the-clinton-street-telephone)
same => n,Macro(say,press-four)
same => n,Macro(say,to-ring-the-ainsworth-street-telephone)
same => n,Macro(say,press-five)
same => n,Macro(say,to-ring-the-taylor-street-telephone)
same => n,Macro(say,press-six)
same => n,Macro(say,for-more-information-about-fewtel)
same => n,Macro(say,press-seven)
same => n,Macro(say,to-speak-to-an-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(incoming-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Goto(futel-conf,s,1)
exten => 3,1,Gosub(wildcard-line-play,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Goto(ring-oskar,s,1)
exten => 5,1,Goto(ring-xnor,s,1)
exten => 6,1,Goto(ring-garth,s,1)
exten => 7,1,Gosub(futel-information,s,1)
same => n,Goto(s,postsetup)
; secret admin menu
exten => 8,1,Gosub(admin-auth,s,1)
same => n,Goto(s,postsetup)
; secret fake admin menu
exten => 9,1,Gosub(incoming-fake-admin-auth,s,1)
same => n,Goto(s,postsetup)
exten => 0,1,VoiceMail(1337,u)
exten => i,1,Goto(s,postsetup)

[futel-information]
exten => s,1,Macro(metric,futel-information)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,welcome-to-fewtel)
same => n,WaitExten(0.1)
same => n,Macro(say,fewtel)
same => n,Macro(say,is)
same => n,Macro(say,portlands-most-exclusive-telephone-network)
same => n,Macro(say,providing)
same => n,Macro(say,telephony)
same => n,Macro(say,and)
same => n,Macro(say,voicemail)
same => n,Macro(say,and)
same => n,Macro(say,human)
same => n,Macro(say,and)
same => n,Macro(say,machine)
same => n,Macro(say,interaction)
same => n,WaitExten(0.25)
same => n,Macro(say,all-services-are-free)
same => n,Macro(say,from-any-fewtel-phone)
same => n,WaitExten(0.25)
same => n,Macro(say,for-more-information)
same => n,Macro(say,contact-the-operator)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,visit-our-website)
same => n,Macro(say,at)
same => n,Macro(say,fewtel-dot-net)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[admin-auth]
    exten => s,1,Macro(metric,admin-auth)
    same => n,Macro(setup-iteration)    
    same => n(postsetup),NoOp
    same => n,Macro(iterate-guard)    
    same => n,Authenticate(${admin_password})
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Goto(admin-ivr,s,1)

[incoming-fake-admin-auth]
    exten => s,1,Macro(metric,incoming-fake-admin-auth)
    same => n,Macro(setup-iteration)    
    same => n(postsetup),NoOp
    same => n,Macro(iterate-guard)    
    same => n,Authenticate(592751)
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Hangup

; extension to start outgoing call
[default-outgoing]
    ; We can't do much here, because our sip clients go directly to the
    ; extension, so we set a variable and go to a context that acts on it.
    ; 996 used for restricted dialtone
    exten => 996,1,Set(destination=restricted-outgoing-dialtone-wrapper)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 997 used for art show oracle phone
    exten => 997,1,Set(destination=oracle-dead)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 998 used for admin phones
    exten => 998,1,Set(destination=admin-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 999 used by oskar curbside
    exten => 999,1,Set(destination=outgoing-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 1000 used by r2d2
    exten => 1000,1,Set(destination=outgoing-dialtone-wrapper)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 1001 is the incoming menu
    exten => 1001,1,Set(destination=incoming-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)

; extension to route outgoing call by extension used
[default-outgoing-by-extension]
exten => s,1,Macro(metric,outgoing-by-extension)
same => n,Set(CALLERID(num)=${callerid})
same => n,Goto(${destination},s,1)

[outgoing-ivr]
exten => s,1,Macro(metric,outgoing-ivr)
same => n,Macro(setup-iteration)
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,AGI(friction.agi,outgoing-ivr)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,to-make-a-call)
same => n,Macro(say,press-one)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-directory)
same => n,Macro(say,press-three)
same => n,Macro(say,for-utilities)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-fewtel-community)
same => n,Macro(say,press-five)
same => n,Macro(say,for-community-services)
same => n,Macro(say,press-six)
; rotating arbitrary featured option
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-seven)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(outgoing-dialtone-wrapper,s,1)
exten => 2,1,Gosub(outgoing-voicemail,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(directory-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 4,1,Gosub(utilities-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 5,1,Gosub(community-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 6,1,Gosub(community-services-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 7,1,Gosub(wildcard-line,s,1)
same => n,Goto(s,postsetup)
; secret admin menu
exten => 8,1,Gosub(admin-auth,s,1)
same => n,Goto(s,postsetup)
exten => 9,1,Goto(911-9,s,1)
exten => 0,1,Goto(operator,s,1)
; secret menu option! Pound gets internal dialtone
exten => #,1,Goto(internal-dialtone-wrapper,s,1)
exten => i,1,Goto(s,postsetup)

; allow 911 from outgoing menu
[911-9]
exten => s,1,Macro(metric,911-9)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-91,s,1)
; busy on invalid
exten => i,1,Busy

[911-91]
exten => s,1,Macro(metric,911-91)
same => n,WaitExten(5)
same => n,Busy
exten => 1,1,Gosub(911-911,s,1)
; busy on invalid
exten => i,1,Busy

[911-911]
exten => s,1,Macro(metric,911-911)
same => n,Macro(say,dialing-nine-one-one)
same => n,Macro(dial,911)

[admin-ivr]
exten => s,1,Macro(metric,admin-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,for-the-fewtel-voice-conference)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-outgoing-menu)
same => n,Macro(say,press-two)
same => n,Macro(say,to-record-a-menu)
same => n,Macro(say,press-three)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
same => n,Goto(s,postsetup)
exten => 2,1,Goto(outgoing-ivr,s,1)
same => n,Goto(s,postsetup)
exten => 3,1,Gosub(record,s,1)
same => n,Goto(s,postsetup)
exten => 0,1,Goto(operator,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,outgoing-dialtone-wrapper)
same => n,DISA(no-password,outgoing-dialtone)

[outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
; 11 digit prefixed with 1: NANPA, normalize to e.164 with + prefix
exten => _1XXXXXXXXXX,1,Macro(filterdial,+${EXTEN})
; 10 digit not prefixed with 1 or 0: NANPA, normalize to e.164 with +1 prefix
exten => _NXXXXXXXXX,1,Macro(filterdial,+1${EXTEN})
exten => _0,1,Goto(operator,s,1)
exten => _#,1,Goto(outgoing-ivr,s,1)
exten => i,1,Busy               ; on invalid annoy caller

[restricted-outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,restricted-outgoing-dialtone-wrapper)
same => n,DISA(no-password,restricted-outgoing-dialtone)

[restricted-outgoing-dialtone]
exten => _911,1,Macro(dial,${EXTEN})
exten => _211,1,Macro(dial,+18666986155)
; 911 test
exten => _933,1,Macro(dial,${EXTEN})
; voip.ms 911 test, which must be in this format for some reason
exten => _15555550911,1,Macro(dial,${EXTEN})
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone-wrapper]
exten => s,1,Macro(metric,internal-dialtone-wrapper)
same => n,DISA(no-password,internal-dialtone)
exten => i,1,Busy               ; on invalid annoy caller

[internal-dialtone]
; dialtone that lets us call selected 3-digit extensions
exten => _650,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _667,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _668,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _680,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _690,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _691,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})
exten => _7XX,1,Dial(SIP/${EXTEN})
same => n,Macro(metric,incoming-dialstatus-${DIALSTATUS})

[followme-operator]
; context to define extensions for op destinations and op actions
exten => 667,1,Dial(SIP/667)
; outgoingcontext variable isn't surviving to here, but we like having specific
; providers so we don't step on dialtone capacity
exten => ${karl_cell},1,Dial(SIP/${karl_cell}@voipms)
exten => ${elijah_cell},1,Dial(SIP/${elijah_cell}@voipms)
exten => ${xnor_cell},1,Dial(SIP/${xnor_cell}@voipms)
exten => ${brandon},1,Dial(SIP/${brandon}@voipms)
exten => ${mathew},1,Dial(SIP/${mathew}@voipms)
exten => ${alma_frankenstein},1,Dial(SIP/${alma_frankenstein}@voipms)
exten => ${emily},1,Dial(SIP/${emily}@voipms)
; allow ops to transfer callers
exten => 995,1,Goto(outgoing-dialtone-wrapper,s,1)
; may need to transfer back to main...
exten => 999,1,Goto(outgoing-ivr,s,1)

[outgoing-voicemail]
exten => s,1,Macro(metric,outgoing-voicemail)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,to-check-your-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,to-create-a-new-voicemail-box)
same => n,Macro(say,press-two)
same => n,Macro(say,to-leave-a-voicemail)
same => n,Macro(say,press-three)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system)
same => n,Macro(say,press-four)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; create vm
exten => 2,1,Macro(metric,next-vm)
same => n,Macro(say,voicemail)    
same => n,Macro(say,can-be-accessed)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,from-the-fewtel-incoming-line)
same => n,AGI(next_vm.agi)
same => n,system(/opt/asterisk/sbin/asterisk -x "voicemail reload")
same => n,VoiceMailMain(${vmbox})
; leave voicemail
exten => 3,1,Macro(metric,voicemail)
exten => 3,2,VoiceMail()
; more information about voicemail
exten => 4,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[incoming-voicemail]
exten => s,1,Macro(metric,incoming-voicemail)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,to-check-your-voicemail)
same => n,Macro(say,press-one)
same => n,Macro(say,to-leave-a-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-more-information-about-the-fewtel-voicemail-system)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
; check voicemail
exten => 1,1,Macro(metric,voicemail-main)
exten => 1,2,VoiceMailMain()
; leave voicemail
exten => 2,1,Macro(metric,voicemail)
exten => 2,2,VoiceMail()
; more information about voicemail
exten => 3,1,Gosub(voicemail-information,s,1)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)

[voicemail-information]
exten => s,1,Macro(metric,voicemail-information)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system)
same => n,Macro(say,can-be-created)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,voicemail-boxes-in-the-fewtel-voicemail-system)
same => n,Macro(say,can-be-accessed)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,from-the-fewtel-incoming-line)
same => n,Macro(say,at)
same => n,Macro(say,five)
same => n,Macro(say,zero)
same => n,Macro(say,three)
same => n,Macro(say,four)
same => n,Macro(say,six)
same => n,Macro(say,eight)
same => n,Macro(say,one)
same => n,Macro(say,three)
same => n,Macro(say,three)
same => n,Macro(say,seven)
same => n,Macro(say,again)
same => n,Macro(say,at)
same => n,Macro(say,five)
same => n,Macro(say,zero)
same => n,Macro(say,three)
same => n,Macro(say,four)
same => n,Macro(say,six)
same => n,Macro(say,eight)
same => n,Macro(say,one)
same => n,Macro(say,three)
same => n,Macro(say,three)
same => n,Macro(say,seven)
same => n,Goto(s,postsetup)
exten => #,1,Return    
exten => i,1,Goto(s,postsetup)
    
[directory-ivr]
exten => s,1,Macro(metric,directory-ivr)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.25)
same => n,Macro(say,for-the-mayor)
same => n,Macro(say,press-one)
same => n,Macro(say,to-apologize)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-wilamette-valley-dream-survey)
same => n,Macro(say,press-three)
same => n,Macro(say,for-a-random-payphone)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-mojave-phone-booth-conference-line)
same => n,Macro(say,press-five)
same => n,Macro(say,for-the-collectors-net-inbound-portal)
same => n,Macro(say,press-six)
same => n,Macro(say,for-sissyphus-gardens)
same => n,Macro(say,press-seven)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(mayor-vm,s,1)
exten => 2,1,Goto(apology-line,s,1)
exten => 3,1,Goto(dream-survey,s,1)
exten => 4,1,Goto(random-payphone,s,1)
exten => 5,1,Goto(mojave-conference,s,1)
exten => 6,1,Goto(cnet-portal,s,1)
exten => 7,1,Goto(lance-e-pants,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-services-ivr]
exten => s,1,Macro(metric,services-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-two-one-one-community-resources)
same => n,Macro(say,press-one)
same => n,Macro(say,for-multnomah-county-mental-health-crisis-intervention)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-call-to-safety-crisis-line)
same => n,Macro(say,press-three)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(info-211,s,1)
exten => 2,1,Goto(mental-health-crisis,s,1)
exten => 3,1,Goto(call-to-safety,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[community-ivr]
exten => s,1,Macro(metric,community-ivr)
same => n,Macro(setup-iteration)    
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)    
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-fewtel-voice-conference)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-wildcard-line)
same => n,Macro(say,press-two)
same => n,Macro(say,for-more-information-about-fewtel)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(futel-conf,s,1)
exten => 2,1,Gosub(wildcard-line,s,1)    
exten => 3,1,Gosub(futel-information,s,1)
same => n,Goto(s,postsetup)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

[utilities-ivr]
exten => s,1,Macro(metric,utilities-ivr)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-trymet-transit-tracker)
same => n,Macro(say,press-two)
same => n,Macro(say,to-access-your-multnomah-county-library-account)
same => n,Macro(say,press-three)
same => n,Macro(say,for-a-random-number)
same => n,Macro(say,press-five)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(current-time,s,1)
exten => 2,1,Goto(trimet-transit-tracker,s,1)
exten => 3,1,Goto(lib-account-line,s,1)
exten => 5,1,Goto(random-number,s,1)
exten => i,1,Goto(s,postsetup)
exten => #,1,Return

; directory
[mayor-vm]
    exten => s,1,Macro(metric,mayor-vm)
    same => n,Macro(dial,+15038234120)

[apology-line]
    exten => s,1,Macro(metric,apology-line)
    same => n,Macro(dial,+13472012446)

[record]
    exten => s,1,Macro(metric,record)
    same => n,AGI(record.agi)

[trimet-transit-tracker]
    exten => s,1,Macro(metric,trimet-transit-tracker)
    same => n,Macro(dial,+15032387433)

[lib-account-line]
    exten => s,1,Macro(metric,lib-account-line)
    same => n,Macro(dial,+15039885342)

[cnet-portal]
    exten => s,1,Macro(metric,cnet-portal)
    same => n,Macro(dial,+19149401363)

[random-payphone]
exten => s,1,Macro(metric,random-payphone)
same => n,Queue(payphones,r)

[lance-e-pants]
    exten => s,1,Macro(metric,lance-e-pants)
    same => n,Macro(dial,${e_pants})

[current-time]
    exten => s,1,Macro(metric,current-time)
    same => n,SayUnixTime()

[info-211]
    exten => s,1,Macro(metric,info-211)
    same => n,Macro(dial,+18666986155)

[dream-survey]
    exten => s,1,Macro(metric,dream-survey)
    same => n,Macro(dial,+19712581465)

[random-number]
; read back a random number to the caller
exten => s,1,Macro(metric,random-number)
same => n(random-number),NoOp
same => n,set(current=${RAND(0,99)})
same => n,Macro(say,your-random-number-is)
same => n(current-number),NoOp
same => n,SayDigits(${current})
same => n(postsetup),NoOp
same => n,Macro(say,to-hear-number-again)
same => n,Macro(say,press-one)
same => n,Macro(say,for-a-random-number)
same => n,Macro(say,press-two)
same => n,WaitExten(0.5)
same => n,Goto(s,postsetup)
exten => 1,1,Goto(s,current-number)
exten => 2,1,Goto(s,random-number)
exten => #,1,Return

[futel-conf]
    ; incoming ConfBridge
    exten => s,1,Macro(metric,futel-conf)
    same => n,ConfBridge(666,futel_conf,futel_conf_user,futel_conf_menu)

[mojave-conference]
exten => s,1,Macro(metric,mojave-conference)
same => n,Macro(dial,+17607339969)

[mental-health-crisis]
exten => s,1,Macro(metric,mental-health-crisis)
same => n,Macro(dial,+15039884888)

[call-to-safety]
; https://calltosafety.org/
exten => s,1,Macro(metric,call-to-safety)
same => n,Macro(dial,+15032355333)

[operator]
exten => s,1,Macro(metric,operator)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,UserEvent(OperatorAttempt)
same => n,Macro(say,please-hold)
same => n,Macro(say,for-the-next-available-operator)
same => n,FollowMe(operator,d)
; if we got here, no operator accepted
same => n,Macro(metric,operator-nopickup)
same => n,UserEvent(OperatorNoPickup)
same => n,VoiceMail(1337,u)
; on invalid repeat, this at least lets panicky users think about what
; they're doing during the intro statements
exten => i,1,Goto(s,postsetup)

; submenu to call out from a conference
; XXX this is an unfiltered DID
; [add-futel-conf]
;     exten => s,1,Macro(metric,add-futel-conf)
;     ; read a phone number from user and store it in ${did}
;     same => n,Read(did,,11)
;     ; TODO use ${outgoing_channel} for the sip trunk
;     same => n,Originate(SIP/callcentric-tishbite/${did},exten,futel-conf)

[wildcard-line]
exten => s,1,Macro(metric,wildcard-line)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,wildcard-line-welcome,wildcard-line)
same => n,Macro(say,wildcard-line-to-contribute,wildcard-line)
same => n,Macro(say,wildcard-line-press-one,wildcard-line)
same => n,Macro(say,wildcard-line-to-hear,wildcard-line)
same => n,Macro(say,wildcard-line-episode-one,wildcard-line)
same => n,Macro(say,wildcard-line-press-two,wildcard-line)
same => n,WaitExten(0.25)
same => n,Goto(s,postsetup)
exten => 1,1,Gosub(wildcard-line-contribute,s,1)
exten => 2,1,Gosub(wildcard-line-play,s,1)
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-contribute]
exten => s,1,Macro(metric,wildcard-line-contribute)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,Macro(say,wildcard-line-welcome,wildcard-line)
same => n,Macro(say,wildcard-line-leave-message,wildcard-line)
same => n,VoiceMail(1337,s)
same => n,Macro(say,wildcard-line-thank-you,wildcard-line)
same => n,Macro(say,wildcard-line-come-back,wildcard-line)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[wildcard-line-play]
exten => s,1,Macro(metric,wildcard-line-play)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,MP3Player(/opt/asterisk/var/lib/asterisk/sounds/futel/wildcard-line/1.mp3)
same => n,Return
exten => #,1,Return
exten => i,1,Goto(s,postsetup)

[oracle-dead]
exten => s,1,Macro(metric,oracle-dead)
same => n,Macro(setup-iteration)
same => n(postsetup),NoOp
same => n,Macro(iterate-guard)
same => n,WaitExten(0.25)
same => n,Gosub(oracle-dead-intro,s,1)
same => n,Gosub(oracle-dead-instructions,s,1)
same => n,Gosub(oracle-dead-entry,s,1)
same => n,Gosub(oracle-dead-setup,s,1)
same => n,Gosub(oracle-dead-sound-intro,s,1)
same => n,Gosub(oracle-dead-sound,s,1)
same => n,Gosub(oracle-dead-debrief,s,1)
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Hangup
; On invalid repreat at beginning, in case a mashed key leaks through to
; this menu. This is nonoptimal, but better than ending the call.
exten => i,1,Goto(s,postsetup)

[oracle-dead-intro]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-long)
same => n,Playback(${agi_out})
same => n,Macro(say,oracle-dead-intro-hello,oracle-dead)
same => n,Macro(say,oracle-dead-intro-to-skip-instructions,oracle-dead)
same => n,Macro(say,oracle-dead-intro-motivation,oracle-dead)
same => n,Macro(say,oracle-dead-intro-no-guarantee-content,oracle-dead)
same => n,Macro(say,press-any-key-to-continue,oracle-dead)
same => n,WaitExten(15)
same => n,Return
; skip instructions on any key
exten => i,1,Return

[oracle-dead-instructions]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-instructions-enter-numbers,oracle-dead)
;same => n,Macro(say,oracle-dead-intro-to-skip-instructions,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-details,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-examples,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-many,oracle-dead)
;same => n,Macro(say,oracle-dead-instructions-enter-numbers-star,oracle-dead)
same => n,Macro(say,press-any-key-to-continue,oracle-dead)
same => n,WaitExten(15)
same => n,Return
; skip instructions on any key
exten => i,1,Return

[oracle-dead-entry]
exten => s,1,NoOp
same => n,Macro(setup-iteration)
same => n,Set(numbers=0)
same => n(postsetup),NoOp
same => n,Macro(say,oracle-dead-instructions-enter-number,oracle-dead)
same => n,Macro(iterate-guard)
same => n(digit),WaitExten(10)
same => n,Goto(s,postsetup) ; on timeout, prompt from the start again
; on any digit except * or #, collect another digit
exten => i,1,NoOp
same => n,Goto(s,digit)  ; collect another digit
exten => #,1,NoOp
same => n,Set(numbers=$[${numbers} + 1])
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-short)
same => n,Playback(${agi_out})
same => n,Macro(say,thank-you,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-number-again,oracle-dead)
same => n,Goto(s,digit)         ; collect another
exten => *,1,NoOp
; if 3 or more entered, done, else nag
same => n,gotoIf($[${numbers} > 2]?done)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-more,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-numbers-why,oracle-dead)
same => n,Macro(say,oracle-dead-instructions-enter-number,oracle-dead)
same => n,Goto(s,digit)
same => n(done),NoOp
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Return

[oracle-dead-setup]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-instructions-when-ready,oracle-dead)
same => n,WaitExten(15)
same => n,Return
exten => i,1,Return

[oracle-dead-sound-intro]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-interstitial-long)
same => n,Playback(${agi_out})
same => n,Macro(say,oracle-dead-setup-attempting,oracle-dead)
same => n,Macro(say,oracle-dead-intro-no-guarantee-recipient,oracle-dead)
same => n,Macro(say,oracle-dead-setup-to-relinquish,oracle-dead)
same => n,Return
exten => i,1,Return

[oracle-dead-sound]
exten => s,1,NoOp
same => n,AGI(random_file.agi,/opt/asterisk/var/lib/asterisk/sounds/futel/oracle-dead-oracle)
same => n,Background(${agi_out})
same => n,Return
exten => i,1,Return

[oracle-dead-debrief]
exten => s,1,NoOp
same => n,Macro(say,oracle-dead-thank-you-for-using-fewtel,oracle-dead)
same => n,Macro(say,oracle-dead-debrief-to-share,oracle-dead)
same => n,Macro(say,oracle-dead-debrief-otherwise,oracle-dead)
same => n,WaitExten(30)
same => n,Return
;exten => #,1,Macro(say,oracle-dead-debrief-record,oracle-dead)
exten => #,1,VoiceMail(1340,u)
same => n,Return
exten => i,1,Return

#include extensions_secret.conf
