[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
TRUNK=DAHDI/G2
oskar_extension=668
r2d2_extension=670
oskar_in_extension=667
oskar_incoming=18452055004
r2d2_incoming=19149775129
;conf_incoming=18455821756
voipms_oskar_in_incoming=5037414912
voipms_leet_incoming=5034681337
; phonetrips recordings
phonetrips_path=/opt/asterisk/var/lib/asterisk/phonetrips

[macro-say]
exten => s,1,AGI(sound_path.agi,${ARG1},${MACRO_CONTEXT})
same => n,Background(${agi_out})

[macro-metric]
exten => s,1,AGI(metric.agi,${ARG1})

[macro-play]
; arg1=path, arg2=file
exten => s,1,MP3Player(${ARG1}/${ARG2})
same => n,Goto(${MACRO_CONTEXT},s,1)

; dial number if it passes filter
[macro-dial]
exten => s,1,AGI(filter_outgoing.agi,${ARG1})
; we passed, continue to dial
same => n,Dial(SIP/${outgoingchannel}/${ARG1},${call_timeout})

; extension to start incoming call
[default-incoming]
exten => _!,1,Macro(metric,default-incoming)
; set variable to the number called, which is in SIP_HEADER(To)
; callcentric gives this as the number called
; ipkall forwards to callcentric, so gives this as the callcentric
; sip number
same => n,Set(caller=${CUT(CUT(SIP_HEADER(To),@,1),:,2)})
same => n,Goto(incoming-route-by-caller,s,1)

[incoming-route-by-caller]
; route to appropriate context based on call origin
exten => s,1,gotoIf($["${caller}" = "${oskar_incoming}"]?ring-oskar,s,1)
same => n,gotoIf($["${caller}" = "${r2d2_incoming}"]?ring-r2d2,s,1)
same => n,gotoIf($["${caller}" = "${voipms_oskar_in_incoming}"]?ring-oskar-in,s,1)
same => n,gotoIf($["${caller}" = "${voipms_leet_incoming}"]?incoming-ivr,s,1)
; fallback, go to the incoming menu
same => n,Goto(incoming-ivr,s,1)

[ring-oskar]
exten => s,1,Macro(metric,ring-oskar)
same => n,Dial(SIP/${oskar_extension},${call_timeout})

[ring-r2d2]
exten => s,1,Macro(metric,ring-r2d2)
same => n,Dial(SIP/${r2d2_extension},${call_timeout})

[ring-oskar-in]
exten => s,1,Macro(metric,ring-oskar-in)
same => n,Dial(SIP/${oskar_in_extension},${call_timeout})

[incoming-ivr]
    exten => s,1,Macro(metric,incoming-ivr)
    same => n,Answer(500)       ; is this necessary?
    same => n,WaitExten(0.1)
    same => n,Macro(say,welcome-to-fewtel)
    same => n,Macro(say,for-voicemail)
    same => n,Macro(say,press-one)
    same => n,Macro(say,for-the-fewtel-voice-conference)
    same => n,Macro(say,press-two)
    same => n,Macro(say,to-ring-the-clinton-street-telephone)
    same => n,Macro(say,press-three)
    same => n,Macro(say,to-speak-to-an-operator)
    same => n,Macro(say,press-four)
    same => n,Macro(say,for-more-information-about-fewtel)
    same => n,Macro(say,press-five)
    ; passive audio 6
    same => n,WaitExten(0.25)
    same => n,Goto(2)           ; repeat first step after metric
    exten => 1,1,VoiceMailMain()
    exten => 2,1,Goto(futel-conf,s,1)
    exten => 3,1,Goto(ring-oskar,s,1)
    exten => 4,1,VoiceMail(1337,u)
    exten => 5,1,Goto(futel-information,s,1)
    ; secret fake admin menu
    exten => 7,1,Goto(incoming-fake-admin-auth,s,1)
    ; secret admin menu
    exten => 8,1,Goto(incoming-admin-auth,s,1)
    exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric

[futel-information]
exten => s,1,Macro(metric,futel-information)
same => n,Macro(say,welcome-to-fewtel)
same => n,WaitExten(0.1)
same => n,Macro(say,fewtel)
same => n,Macro(say,is)
same => n,Macro(say,portlands-most-exclusive-telephone-network)
same => n,Macro(say,providing)
same => n,Macro(say,telephony)
same => n,Macro(say,and)
same => n,Macro(say,voicemail)
same => n,Macro(say,and)
same => n,Macro(say,human)
same => n,Macro(say,and)
same => n,Macro(say,machine)
same => n,Macro(say,interaction)
same => n,WaitExten(0.25)
same => n,Macro(say,all-services-are-free)
same => n,Macro(say,from-any-fewtel-phone)
same => n,WaitExten(0.25)
same => n,Macro(say,for-more-information)
same => n,Macro(say,contact-the-operator)
same => n,Macro(say,from-any-fewtel-phone)
same => n,Macro(say,or)
same => n,Macro(say,visit-our-website)
same => n,Macro(say,at)
same => n,Macro(say,fewtel-dot-net)
same => n,WaitExten(0.25)
same => n,Goto(2)           ; repeat first step after metric
exten => #,1,Goto(incoming-ivr,s,1)    
exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric

[incoming-admin-auth]
    exten => s,1,Macro(metric,incoming-admin-auth)
    same => n,Authenticate(${admin_password})
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Goto(admin-ivr,s,1)

[incoming-fake-admin-auth]
    exten => s,1,Macro(metric,incoming-fake-admin-auth)
    same => n,Authenticate(592751)
    same => n,Wait(0.25)    ;avoid digits leaking into next menu
    same => n,Hangup

; extension to start outgoing call
[default-outgoing]
    ; We can't do much here, because our sip clients go directly to the
    ; extension, so we set a variable and go to a context that acts on it.
    ; 998 used for admin phones
    exten => 998,1,Set(destination=admin-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 999 used by oskar curbside
    exten => 999,1,Set(destination=outgoing-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 1000 used by r2d2
    exten => 1000,1,Set(destination=outgoing-dialtone-wrapper)
    same => n,Goto(default-outgoing-by-extension,s,1)
    ; 1001 is the incoming menu
    exten => 1001,1,Set(destination=incoming-ivr)
    same => n,Goto(default-outgoing-by-extension,s,1)

; extension to route outgoing call by extension used
[default-outgoing-by-extension]
exten => s,1,Macro(metric,outgoing-by-extension)
same => n,Set(CALLERID(num)=${callerid})
same => n,Goto(${destination},s,1)

[outgoing-ivr]
exten => s,1,Macro(metric,outgoing-ivr)
same => n,WaitExten(0.25)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,to-make-a-call)
same => n,Macro(say,press-one)
same => n,Macro(say,for-voicemail)
same => n,Macro(say,press-two)
same => n,Macro(say,for-the-directory)
same => n,Macro(say,press-three)
same => n,Macro(say,for-utilities)
same => n,Macro(say,press-four)
same => n,Macro(say,for-the-fewtel-community)
same => n,Macro(say,press-five)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(2)            ; repeat first step after metric
exten => 1,1,Goto(outgoing-dialtone-wrapper,s,1)
exten => 2,1,Goto(voicemail-ivr,s,1)
exten => 3,1,Goto(directory-ivr,s,1)
exten => 4,1,Goto(utilities-ivr,s,1)
exten => 5,1,Goto(community-ivr,s,1)
;exten => 9,1,Goto(directory-ivr,s,1) ; may want to start 911
exten => 0,1,Goto(operator,s,1)
; secret menu option! Pound gets internal dialtone
exten => #,1,Goto(internal-dialtone-wrapper,s,1)
exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric

[admin-ivr]
exten => s,1,Macro(metric,admin-ivr)
same => n,WaitExten(0.1)
same => n,Macro(say,welcome-to-fewtel)
same => n,Macro(say,to-record-a-menu)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-operator)
same => n,Macro(say,press-zero)
same => n,WaitExten(0.25)
same => n,Goto(2)           ; repeat first step after metric
; record a menu
exten => 1,1,Goto(record,s,1)
exten => 0,1,Goto(operator,s,1)
exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric
exten => #,1,Goto(outgoing-ivr,s,1) ; return to previous menu

[outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,outgoing-dialtone-wrapper)
same => n,DISA(no-password,outgoing-dialtone)

[outgoing-dialtone]
; dialtone that lets us make a domestic call only
; block these, but this prevents failure on first bad digit
;exten => _1900XXXXXXX,1,Busy
;exten => _1976XXXXXXX,1,Busy
; send 911 to dialplan unconditionally
exten => _911,1,Dial(SIP/${outgoingchannel}/${EXTEN})
; send qualified numbers to dial macro, prepending 1 if necessary
exten => _1[2-8]XXNXXXXXX,1,Macro(dial,${EXTEN})
exten => _[2-8]XXNXXXXXX,1,Macro(dial,1${EXTEN})
exten => _1[2-9][1-9]XNXXXXXX,1,Macro(dial,${EXTEN})
exten => _[2-9][1-9]XNXXXXXX,1,Macro(dial,1${EXTEN})
; send 0 to operator
exten => _0,1,Goto(operator,s,1)
; send # to outgoing ivr
exten => _#,1,Goto(outgoing-ivr,s,1)

[internal-dialtone-wrapper]
exten => s,1,Macro(metric,internal-dialtone-wrapper)
same => n,DISA(no-password,internal-dialtone)

[internal-dialtone]
; dialtone that lets us call selected 3-digit extensions
exten => _66X,1,Dial(SIP/${EXTEN},${call_timeout})
exten => _7XX,1,Dial(SIP/${EXTEN},${call_timeout})
exten => _#,1,Goto(outgoing-ivr,s,1)

[voicemail-ivr]
    exten => s,1,Macro(metric,voicemail-ivr)
    same => n,WaitExten(0.25)
    same => n,Macro(say,to-check-your-voicemail)
    same => n,Macro(say,press-one)
    same => n,Macro(say,to-create-a-new-voicemail-box)
    same => n,Macro(say,press-two)
    same => n,Macro(say,to-leave-a-voicemail)
    same => n,Macro(say,press-three)
    same => n,WaitExten(0.25)
    same => n,Goto(2)           ; repeat first step after metric
    ; check voicemail
    exten => 1,1,Macro(metric,voicemail-main)
    exten => 1,2,VoiceMailMain()
    ; create vm
    exten => 2,1,Macro(metric,next-vm)
    exten => 2,2,AGI(next_vm.agi)
    same => n,system(/opt/asterisk/sbin/asterisk -x "voicemail reload")
    same => n,VoiceMailMain(${vmbox})
    ; leave voicemail
    exten => 3,1,Macro(metric,voicemail)
    exten => 3,2,VoiceMail()
    exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric

[directory-ivr]
    exten => s,1,Macro(metric,directory-ivr)
    same => n,WaitExten(0.25)
    same => n,Macro(say,for-the-mayor)
    same => n,Macro(say,press-one)
    same => n,Macro(say,for-two-one-one-community-resources)
    same => n,Macro(say,press-two)
    same => n,Macro(say,to-apologize)
    same => n,Macro(say,press-three)
    same => n,Macro(say,for-the-wilamette-valley-dream-survey)
    same => n,Macro(say,press-four)
    same => n,Macro(say,for-the-collectors-net-inbound-portal)
    same => n,Macro(say,press-seven)
    same => n,Macro(say,for-sissyphus-gardens)
    same => n,Macro(say,press-eight)
    same => n,WaitExten(0.25)
    same => n,Goto(2)           ; repeat first step after metric
    exten => 1,1,Goto(mayor-vm,s,1)
    exten => 2,1,Goto(info-211,s,1)
    exten => 3,1,Goto(apology-line,s,1)
    exten => 4,1,Goto(dream-survey,s,1)
    exten => 7,1,Goto(cnet-portal,s,1)
    exten => 8,1,Goto(lance-e-pants,s,1)
    exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric
    exten => #,1,Goto(outgoing-ivr,s,1) ; return to previous menu

[community-ivr]
    exten => s,1,Macro(metric,community-ivr)
    same => n,WaitExten(0.1)
    same => n,Macro(say,for-the-fewtel-voice-conference)
    same => n,Macro(say,press-one)
    ;same => n,Macro(say,to-record-a-menu)
    ;same => n,Macro(say,press-two)
    ;same => n,Macro(say,for-passive-audio-input)
    ;same => n,Macro(say,press-three)
    same => n,WaitExten(0.25)
    same => n,Goto(2)           ; repeat first step after metric
    exten => 1,1,Goto(futel-conf,s,1)
    ;exten => 2,1,Goto(record,s,1)
    exten => 3,1,Goto(audio-ivr,s,1)
    exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric
    exten => #,1,Goto(outgoing-ivr,s,1) ; return to previous menu

[utilities-ivr]
exten => s,1,Macro(metric,utilities-ivr)
same => n,WaitExten(0.1)
same => n,Macro(say,for-the-current-time)
same => n,Macro(say,press-one)
same => n,Macro(say,for-the-trymet-transit-tracker)
same => n,Macro(say,press-two)
same => n,Macro(say,to-access-your-multnomah-county-library-account)
same => n,Macro(say,press-three)
same => n,WaitExten(0.25)
same => n,Goto(2)           ; repeat first step after metric
exten => 1,1,Goto(current-time,s,1)
exten => 2,1,Goto(trimet-transit-tracker,s,1)
exten => 3,1,Goto(lib-account-line,s,1)
exten => i,1,Goto(s,2)           ; on invalid repeat first step after metric
exten => #,1,Goto(outgoing-ivr,s,1) ; return to previous menu

; directory
[mayor-vm]
    exten => s,1,Macro(metric,mayor-vm)
    same => n,Dial(SIP/${outgoingchannel}/15038234127,${call_timeout})

[apology-line]
    exten => s,1,Macro(metric,apology-line)
    same => n,Dial(SIP/${outgoingchannel}/13472012446,${call_timeout})

[record]
    exten => s,1,Macro(metric,record)
    same => n,AGI(record.agi)

[trimet-transit-tracker]
    exten => s,1,Macro(metric,trimet-transit-tracker)
    same => n,Dial(SIP/${outgoingchannel}/15032387433,${call_timeout})

[lib-account-line]
    exten => s,1,Macro(metric,lib-account-line)
    same => n,Dial(SIP/${outgoingchannel}/15039885342,${call_timeout})

[cnet-portal]
    exten => s,1,Macro(metric,cnet-portal)
    same => n,Dial(SIP/${outgoingchannel}/12062036610,${call_timeout})

[lance-e-pants]
    exten => s,1,Macro(metric,lance-e-pants)
    same => n,Dial(SIP/${outgoingchannel}/${e_pants},${call_timeout})

[current-time]
    exten => s,1,Macro(metric,current-time)
    same => n,SayUnixTime()

[info-211]
    exten => s,1,Macro(metric,info-211)
    same => n,Dial(SIP/${outgoingchannel}/18666986155,${call_timeout})

[dream-survey]
    exten => s,1,Macro(metric,dream-survey)
    same => n,Dial(SIP/${outgoingchannel}/19712581465,${call_timeout})

[futel-conf]
    ; incoming ConfBridge
    exten => s,1,Macro(metric,futel-conf)
    same => n,ConfBridge(666,futel_conf,futel_conf_user,futel_conf_menu)

[audio-ivr]
    exten => s,1,Macro(metric,audio-ivr)
    same => n,WaitExten(0.1)
    same => n,Macro(say,select-a-phonetrips-recording-to-enjoy)
    same => n,Macro(say,for-classic-tandem-stacking)
    same => n,Macro(say,press-one)
    same => n,Macro(say,for-the-how-evan-doorbell-became-a-phone-freak-series)
    same => n,Macro(say,press-two)
    same => n,Macro(say,for-greenville-north-carolina-en-ex-one-series)
    same => n,Macro(say,press-three)
    same => n,Goto(2)
    exten => 1,1,Macro(play,${phonetrips_path},classtack1HQ.mp3,audio-ivr)
    exten => 2,1,Goto(ed-phreak-ivr,s,1)
    exten => 3,1,Goto(ed-greenville-ivr,s,1)
    exten => #,1,Goto(outgoing-ivr,s,1) ; return to previous menu

[ed-phreak-ivr]
    ; evan doorbell "how i became a phone phreak" series
    exten => s,1,Macro(metric,ed-phreak-ivr)
    same => n,Waitexten(0.1)
    same => n,Macro(say,for-part-one)
    same => n,Macro(say,press-one)
    same => n,Macro(say,for-part-two)
    same => n,Macro(say,press-two)
    same => n,Macro(say,for-part-three)
    same => n,Macro(say,press-three)
    same => n,Macro(say,for-part-four)
    same => n,Macro(say,press-four)
    same => n,Macro(say,for-part-five)
    same => n,Macro(say,press-five)
    same => n,Macro(say,for-part-six)
    same => n,Macro(say,press-six)
    same => n,Goto(2)
    exten => 1,1,Macro(play,${phonetrips_path},HowBPhreak1HQ.mp3,ed-phreak-ivr)
    exten => 2,1,Macro(play,${phonetrips_path},HowBPhreak2HQ.mp3,ed-phreak-ivr)
    exten => 3,1,Macro(play,${phonetrips_path},HowBPhreak3HQ.mp3,ed-phreak-ivr)
    exten => 4,1,Macro(play,${phonetrips_path},HowBPhreak4HQ.mp3,ed-phreak-ivr)
    exten => 5,1,Macro(play,${phonetrips_path},HowBPhreak5HQ.mp3,ed-phreak-ivr)
    exten => 6,1,Macro(play,${phonetrips_path},HowBPhreak6HQ.mp3,ed-phreak-ivr)
    exten => i,1,Goto(s,2)
    exten => #,1,Goto(audio-ivr,s,1) ; return to previous menu

[ed-greenville-ivr]
    ; evan doorbell "greenville NC NX1" series
    exten => s,1,Macro(metric,ed-greenville-ivr)
    same => n,WaitExten(0.1)
    same => n,Macro(say,for-one-ex-ex-codes-part-one)
    same => n,Macro(say,press-one)
    same => n,Macro(say,for-one-ex-ex-codes-part-two)
    same => n,Macro(say,press-two)
    same => n,Macro(say,for-greeville-long-distance)
    same => n,Macro(say,press-three)
    same => n,Goto(2)
    exten => 1,1,Macro(play,${phonetrips_path},Greenville1xxp1HQ.mp3,ed-greenville-ivr)
    exten => 2,1,Macro(play,${phonetrips_path},Greenville1xxp2HQ.mp3,ed-greenville-ivr)
    exten => 3,1,Macro(play,${phonetrips_path},GreenvilleLDHQ.mp3,ed-greenville-ivr)
    exten => i,1,Goto(s,2)
    exten => #,1,Goto(audio-ivr,s,1) ; return to previous menu

[operator]
exten => s,1,Macro(metric,operator)
same => n,Macro(say,please-hold)
same => n,Macro(say,for-the-next-available-operator)
; callcentric allows two outgoings
same => n,Dial(SIP/667&SIP/${outgoingchannel}/${karl_cell}&SIP/${outgoingchannel}/${elijah_cell},${call_timeout})

; submenu to call out from a conference
; XXX don't ever use a bare DID like this, filter
; [add-futel-conf]
;     exten => s,1,Macro(metric,add-futel-conf)
;     ; read a phone number from user and store it in ${did}
;     same => n,Read(did,,11)
;     ; TODO use ${outgoing_channel} for the sip trunk
;     same => n,Originate(SIP/callcentric-tishbite/${did},exten,futel-conf)

#include extensions_secret.conf
