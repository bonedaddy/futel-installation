[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
TRUNK=DAHDI/G2					; Trunk interface
oskar_extension=668
r2d2_extension=670
oskar_incoming=18452055004
r2d2_incoming=19149775129

[macro-say]
exten => s,1,AGI(sound_path.agi,${ARG1})
exten => s,2,Background(${agi_out})

[macro-metric]
exten => s,1,AGI(metric.agi,${ARG1})

[default-incoming]
exten => s,1,Macro(metric,default-incoming)
; set variable to the number called, which is in SIP_HEADER(To)
; callcentric gives this as the number called
; ipkall forwards to callcentric, so gives this as the callcentric
; sip number
same => n,Set(caller=${CUT(CUT(SIP_HEADER(To),@,1),:,2)})
same => n,Goto(incoming-route-by-caller,s,1)

[incoming-route-by-caller]
; route to appropriate context based on call origin
exten => s,1,gotoIf($["${caller}" = "${oskar_incoming}"]?ring-oskar,s,1)
same => n,gotoIf($["${caller}" = "${r2d2_incoming}"]?ring-r2d2,s,1)
; fallback, go to the incoming menu
same => n,Goto(incoming-ivr,s,1)

[ring-oskar]
exten => s,1,Macro(metric,ring-oskar)
same => n,Dial(SIP/${oskar_extension},${call_timeout})
[ring-r2d2]
exten => s,1,Macro(metric,ring-r2d2)
same => n,Dial(SIP/${r2d2_extension},${call_timeout})

[incoming-ivr]
    exten => s,1,Macro(metric,incoming-ivr)
    same => n,Answer(500)
    same => n,WaitExten(0.1)
    same => n,Macro(say,welcome-to-fewtel)
    same => n,Macro(say,to-check-your-voicemail)
    same => n,Macro(say,press-one)
    same => n,Macro(say,to-leave-a-voicemail)
    same => n,Macro(say,press-two)
    same => n,WaitExten(0.25)
    same => n,Goto(2)
    ; check voicemail
    exten => 1,1,VoiceMailMain()
    ; leave voicemail
    exten => 2,1,VoiceMail()
    ; secret admin menu
    exten => 8,1,Goto(incoming-admin-auth,s,1)
    ; secret recording menu
    exten => 9,1,Goto(record,s,1)

[incoming-admin-auth]
    exten => s,1,Macro(metric,incoming-admin-auth)
    same => n,Authenticate(${admin_password})
    same => n,Wait(0.25)	;avoid digits leaking into next menu
    same => n,Goto(outgoing-ivr,s,1)

[default-outgoing]
    ; can't metric here, because we're going straight to an extension
    ; 999 used by oskar curbside
    exten => 999,1,Goto(outgoing-ivr,s,1)
    ; 1000 used by r2d2
    exten => 1000,1,Goto(outgoing-dialtone-wrapper,s,1)

[outgoing-ivr]
   exten => s,1,Macro(metric,outgoing-ivr)
   same => n,Answer(500)
   same => n,WaitExten(0.25)
   same => n,Macro(say,welcome-to-fewtel)
   same => n,Macro(say,to-make-a-call)
   same => n,Macro(say,press-one)
   same => n,Macro(say,for-voicemail)
   same => n,Macro(say,press-two)
   same => n,Macro(say,for-the-directory)
   same => n,Macro(say,press-three)
   same => n,Macro(say,for-the-operator)
   same => n,Macro(say,press-zero)
   same => n,WaitExten(0.25)
   same => n,Goto(2)
   exten => 1,1,Goto(outgoing-dialtone-wrapper,s,1)
   exten => 2,1,Goto(voicemail-ivr,s,1)
   exten => 3,1,Goto(directory-ivr,s,1)
   ;exten => 9,1,Goto(directory-ivr,s,1) ; may want to start 911
   exten => 0,1,Goto(operator,s,1)
   ; secret menu option! Pound gets internal dialtone
   exten => #,1,Goto(internal-dialtone-wrapper,s,1)

[outgoing-dialtone-wrapper]
exten => s,1,Macro(metric,outgoing-dialtone-wrapper)
same => n,DISA(no-password,outgoing-dialtone)

[outgoing-dialtone]
; dialtone that lets us make a domestic call only
; block these, but this prevents failure on first bad digit
;exten => _1900XXXXXXX,1,Busy
;exten => _1976XXXXXXX,1,Busy
; send 911 to dialplan
exten => _911,1,Dial(SIP/${outgoingchannel}/${EXTEN})
; send these to dialplan, prepending 1 if necessary
exten => _1[2-8]XXNXXXXXX,1,Dial(SIP/${outgoingchannel}/${EXTEN},${call_timeout})
exten => _[2-8]XXNXXXXXX,1,Dial(SIP/${outgoingchannel}/1${EXTEN},${call_timeout})
exten => _1[2-9][1-9]XNXXXXXX,1,Dial(SIP/${outgoingchannel}/${EXTEN},${call_timeout})
exten => _[2-9][1-9]XNXXXXXX,1,Dial(SIP/${outgoingchannel}/1${EXTEN},${call_timeout})
exten => _0,1,Goto(operator,s,1)
exten => _#,1,Goto(outgoing-ivr,s,1)

[internal-dialtone-wrapper]
exten => s,1,Macro(metric,internal-dialtone-wrapper)
same => n,DISA(no-password,internal-dialtone)

[internal-dialtone]
; dialtone that lets us call 3-digit extensions starting with 7
exten => _7XX,1,Dial(SIP/${EXTEN},${call_timeout})

[voicemail-ivr]
    exten => s,1,Macro(metric,voicemail-ivr)
    same => n,WaitExten(0.25)
    same => n,Macro(say,to-check-your-voicemail)
    same => n,Macro(say,press-one)
    same => n,Macro(say,to-create-a-new-voicemail-box)
    same => n,Macro(say,press-two)
    same => n,Macro(say,to-leave-a-voicemail)
    same => n,Macro(say,press-three)
    same => n,WaitExten(0.25)
    same => n,Goto(1)
    ; check voicemail
    exten => 1,1,VoiceMailMain()
    ; create vm
    exten => 2,1,AGI(next_vm.agi)
    same => n,system(/opt/asterisk/sbin/asterisk -x "voicemail reload")
    same => n,VoiceMailMain(${vmbox})
    ; leave voicemail
    exten => 3,1,VoiceMail()
        
[directory-ivr]
    exten => s,1,Macro(metric,directory-ivr)
    same => n,WaitExten(0.25)
    same => n,Macro(say,for-the-mayor)
    same => n,Macro(say,press-one)
    same => n,Macro(say,to-apologize)
    same => n,Macro(say,press-two)
    ;same => n,Macro(say,for-the-weather-forcast)
    ;same => n,Macro(say,press-three)
    ;same => n,Macro(say,for-amtrak)
    ;same => n,Macro(say,press-four)
    same => n,Macro(say,for-the-trymet-transit-tracker)
    same => n,Macro(say,press-five)
    same => n,Macro(say,to-access-your-multnomah-county-library-account)
    same => n,Macro(say,press-six)
    same => n,Macro(say,for-the-collectors-net-inbound-portal)
    same => n,Macro(say,press-seven)
    same => n,Macro(say,for-lance-e-pants)
    same => n,Macro(say,press-eight)
    ;same => n,Macro(say,for-the-mutant-message-service)
    ;same => n,Macro(say,press-nine)
    same => n,WaitExten(0.25)
    same => n,Goto(1)
    exten => 1,1,Goto(mayor-vm,s,1)
    exten => 2,1,Goto(apology-line,s,1)
    ;exten => 3,1,Goto(dial-a-forecast,s,1)
    ;exten => 4,1,Goto(ask-julie-amtrak,s,1)
    exten => 5,1,Goto(trimet-transit-tracker,s,1)
    exten => 6,1,Goto(lib-account-line,s,1)
    exten => 7,1,Goto(cnet-portal,s,1)
    exten => 8,1,Goto(lance-e-pants,s,1)
    ;exten => 9,1,Goto(mutant-message-service,s,1)
  
; directory
[mayor-vm]
    exten => s,1,Macro(metric,mayor-vm)
    same => n,Dial(SIP/${outgoingchannel}/15038234127,${call_timeout})

[apology-line]
    exten => s,1,Macro(metric,apology-line)
    same => n,Dial(SIP/${outgoingchannel}/13472012446,${call_timeout})

; [dial-a-forecast]
;     exten => s,1,Dial(SIP/${outgoingchannel}/15032619246,${call_timeout})

[record]
    exten => s,1,Macro(metric,record)
    same => n,AGI(record.agi)

[trimet-transit-tracker]
    exten => s,1,Macro(metric,trimet-transit-tracker)
    same => n,Dial(SIP/${outgoingchannel}/15032387433,${call_timeout})

[lib-account-line]
    exten => s,1,Macro(metric,lib-account-line)
    same => n,Dial(SIP/${outgoingchannel}/15039885342,${call_timeout})

[cnet-portal]
    exten => s,1,Macro(metric,cnet-portal)
    same => n,Dial(SIP/${outgoingchannel}/12062036610,${call_timeout})

[lance-e-pants]
    exten => s,1,Macro(metric,lance-e-pants)
    same => n,Dial(SIP/${outgoingchannel}/${e_pants},${call_timeout})

[operator]
exten => s,1,Macro(metric,operator)
;callcentric allows two outgoings
same => n,Dial(SIP/${outgoingchannel}/${karl_cell}&SIP/${outgoingchannel}/${elijah_cell},${call_timeout})

#include extensions_secret.conf

